name: Create PR from Issue (if valid format)

on:
  issues:
    types: [opened]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Extract branch name from issue title
        id: extract
        run: |
          TITLE="${{ github.event.issue.title }}"
          if echo "$TITLE" | grep -q "："; then
            BRANCH_NAME=$(echo "$TITLE" | awk -F '：' '{print $2}' | xargs)
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          else
            echo "branch_name=" >> $GITHUB_OUTPUT
          fi

      - name: Check if branch exists
        id: check_branch
        if: steps.extract.outputs.branch_name != ''
        run: |
          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup GitHub CLI
        uses: actions/setup-gh@v2

      - name: Create Pull Request via gh CLI
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          gh pr create \
            --title "Resolve #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" \
            --body "This PR was automatically created for issue #${{ github.event.issue.number }}." \
            --base master \
            --head "${{ steps.extract.outputs.branch_name }}" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add label to issue
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          issue_number: ${{ github.event.issue.number }}
          labels: 自動PR作成済

      - name: Comment PR link to issue
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            // gh pr create は PR URL を標準出力しないので、以下はGitHub APIでPR検索してリンク取得の例
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.issue.title.split('：')[1].trim()}`,
              state: 'open',
            });
            if (pulls.length > 0) {
              const prUrl = pulls[0].html_url;
              const body = `🔗 自動PRが作成されました: ${prUrl}`;
              await github.rest.issues.createComment({
                issue_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }
